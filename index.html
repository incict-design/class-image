<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>登録制 画像共有アプリ</title>
<style>
body { font-family: system-ui, -apple-system, "メイリオ", sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background:#fafafa; }
header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
#gallery {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  grid-auto-rows: 200px;
  gap: 10px;
  justify-items: center;
  margin-top: 10px;
}
@media (max-width: 480px) { #gallery { grid-template-columns: repeat(2, 1fr); } }
.card {
  width: 110px; height: 150px; border: 1px solid #ddd; border-radius: 8px;
  padding: 4px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; position: relative;
}
.card img { width: 100%; height: 100px; object-fit: cover; border-radius: 6px; transition: transform 0.3s; }
.card img:hover { transform: scale(1.05); }
.meta { font-size: 12px; color: #555; margin-top: 4px; white-space: pre-line; text-align: center; }
#status { font-size: 13px; color: #333; }
button { cursor: pointer; padding: 6px 10px; border-radius: 6px; border: 1px solid #bbb; background: #f7f7f7; }
.upload-row { display: flex; gap: 6px; align-items: center; margin-top: 4px; }
.upload-row input, .upload-row button { height: 32px; }
#overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000;
}
#overlay img { max-width: 90%; max-height: 90%; border-radius: 8px; cursor: pointer; }
.auth { margin-top: 18px; padding: 12px; border: 1px solid #eee; border-radius: 8px; background: #fff; }
.auth-header { display: flex; align-items: center; gap: 8px; }
.auth-row { display: flex; gap: 10px; margin-top: 8px; }
.auth-row input { padding: 6px 8px; border-radius: 6px; border: 1px solid #ddd; }
#authStatus { font-size: 14px; color: #333; margin-left:8px; }
.omikuji-result { margin-top:8px; padding:10px; background:#fff7e6; border-radius:8px; border-left:4px solid #ff9500; font-size:14px; text-align:center; display:none; }
.schedule-display { margin-top:10px; padding:10px; background:#f0f0f0; border-left:4px solid #4facfe; border-radius:6px; display:none; }
.schedule-date { font-weight:600; color:#4facfe; margin-bottom:4px; }
.schedule-content { font-size:14px; color:#333; }
.date-buttons { margin-top:10px; display:flex; flex-wrap:wrap; gap:6px; }
.date-button, .omikuji-button { padding:6px 10px; border-radius:6px; border:1px solid #bbb; background:#f7f7f7; cursor:pointer; }
</style>
</head>
<body>

<header>
  <h1>11月17日（月）</h1>
  <div id="status" style="margin-left:auto"></div>
</header>

<!-- おみくじ -->
<div class="date-buttons">
  <button class="omikuji-button" onclick="drawOmikuji()">おみくじ 1日2回</button>
</div>
<div id="omikujiResult" class="omikuji-result"></div>

<!-- スケジュール -->
<div class="date-buttons">
  <button class="date-button" onclick="showSchedule('today')">本日</button>
  <button class="date-button" onclick="showSchedule('tomorrow')">明日</button>
  <button class="date-button" onclick="showSchedule('following')">明後日</button>
  <button class="date-button" onclick="showSchedule('test3')">11月20日（木）</button>
  <button class="date-button" onclick="showSchedule('test4')">11月21日（金）</button>
</div>
<div id="scheduleDisplay" class="schedule-display">
  <div id="scheduleDate" class="schedule-date"></div>
  <div id="scheduleContent" class="schedule-content"></div>
</div>

<!-- Webページ表示エリア -->

<div id="drawArea">
  <iframe id="drawFrame" src="https://incict-design.github.io/spelling/" allowfullscreen style="width:100%;height:300px;border:none;border-radius:6px;margin-top:10px;"></iframe>
</div>

<div id="drawArea">
  <iframe id="drawFrame" src="https://incict-design.github.io/hikariplay/" allowfullscreen style="width:100%;height:300px;border:none;border-radius:6px;"></iframe>
</div>

<!-- ギャラリー -->
<section>
  <h2>画廊SHION</h2>
  <div id="gallery"></div>
  <div class="upload-row">
    <input id="fileInput" type="file" accept="image/*">
    <button id="uploadBtn">アップロード</button>
    <span id="status"></span>
  </div>
</section>

<!-- アカウント -->
<section class="auth">
  <div class="auth-header">
    <h3 style="margin:0;">アカウント</h3>
    <div id="authStatus">未ログイン</div>
    <button id="loginBtn">ログイン</button>
    <button id="logoutBtn" style="display:none;">ログアウト</button>
  </div>
  <div class="auth-row">
    <input id="email" type="email" placeholder="icj21/ich24....@s.icc.ac.jp">
    <input id="password" type="password" placeholder="パスワード：情報教室">
  </div>
</section>

<div id="overlay">
  <img id="overlayImg" src="">
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
// ===== おみくじ・スケジュール =====
const scheduleData = {
  'today': { date: '本日', content: '<div>趣味は勉強、特技はテスト</div>' },
  'tomorrow': { date: '明日', content: '<div>1限：論理国語</div><div>2限：文：生物基礎 / 理：化学</div>' },
  'following': { date: '明後日', content: '<div>1限：公共</div><div>2限：論理・表現Ⅱ</div><div>3限：４組のみ：地理探究</div>' },
  'test3': { date: '11月20日（木）', content: '<div>1限：古典探究</div><div>2限：英語CⅡ</div>' },
  'test4': { date: '11月21日（金）', content: '<div>1限：文：世・日 / 理：物・生</div><div>2限：数学ⅡB</div>' }
};
const omikujiResults = [
  {name:'大狂',text:'隕石注意'},
  {name:'凶',text:'水鉄砲で撃たれる'},
  {name:'吉',text:'脳筋大爆発！'},
  {name:'小吉',text:'脳みそ絶対零度'},
  {name:'中吉',text:'常北ファームで愛のささやき'},
  {name:'大吉',text:'萩谷と睨めっこ'}
];

function getTodayKey(){ const t=new Date(); return t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate(); }
function getDrawCount(){ const k=getTodayKey(); const d=JSON.parse(localStorage.getItem("omikujiCount"))||{}; return d[k]||0; }
function incrementDrawCount(){ const k=getTodayKey(); const d=JSON.parse(localStorage.getItem("omikujiCount"))||{}; d[k]=(d[k]||0)+1; localStorage.setItem("omikujiCount",JSON.stringify(d)); }
function getSecondResult(){ return JSON.parse(localStorage.getItem(getTodayKey()+"-secondResult")); }
function setSecondResult(r){ localStorage.setItem(getTodayKey()+"-secondResult",JSON.stringify(r)); }

function drawOmikuji(){
  const count=getDrawCount();
  const box=document.getElementById("omikujiResult");
  box.style.display="block";
  if(count===0||count===1){
    const r=Math.floor(Math.random()*omikujiResults.length);
    const res=omikujiResults[r];
    if(count===1) setSecondResult(res);
    incrementDrawCount();
    box.innerHTML=`今日の運勢：<strong>${res.name}</strong><br>${res.text}`;
  }else{
    const saved=getSecondResult();
    box.innerHTML=saved?`今日の運勢：<strong>${saved.name}</strong><br>${saved.text}`:"（2回目の結果がありません）";
  }
}

function showSchedule(k){
  const d=document.getElementById("scheduleDisplay");
  document.getElementById("scheduleDate").textContent=scheduleData[k].date;
  document.getElementById("scheduleContent").innerHTML=scheduleData[k].content;
  d.style.display="block";
}

// ===== Firebase 画像共有 =====
const firebaseConfig = {
  apiKey: "AIzaSyCzDqI2YaOLoU4muurvvxBs4fOOSkH8Yew",
  authDomain: "image-share-89916.firebaseapp.com",
  projectId: "image-share-89916",
  storageBucket: "image-share-89916.firebasestorage.app",
  messagingSenderId: "859639070035",
  appId: "1:859639070035:web:aab7543659c3d1a877f5a6"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.firestore(), storage=firebase.storage();

const emailInput=document.getElementById("email"), passwordInput=document.getElementById("password"),
loginBtn=document.getElementById("loginBtn"), logoutBtn=document.getElementById("logoutBtn"),
authStatus=document.getElementById("authStatus"), fileInput=document.getElementById("fileInput"),
uploadBtn=document.getElementById("uploadBtn"), status=document.getElementById("status"),
gallery=document.getElementById("gallery"), overlay=document.getElementById("overlay"),
overlayImg=document.getElementById("overlayImg");

// 認証状態変更
auth.onAuthStateChanged(user => {
  if(user){
    authStatus.textContent = `ログイン中: ${user.displayName||user.email}`;
    loginBtn.style.display="none";
    logoutBtn.style.display="inline-block";
  }else{
    authStatus.textContent = "未ログイン";
    loginBtn.style.display="inline-block";
    logoutBtn.style.display="none";
  }
});

// ログイン
loginBtn.addEventListener("click",async()=>{
  const email=emailInput.value.trim();
  const pass=passwordInput.value;
  if(!email||!pass){ alert("メールとパスワードを入力してください"); return;}
  try{
    const user = await auth.signInWithEmailAndPassword(email,pass);
    if(!user.user.emailVerified){ alert("メール認証が完了していません"); await auth.signOut(); return;}
  }catch(e){ alert(e.message);}
});

// ログアウト
logoutBtn.addEventListener("click",()=>auth.signOut());

// アップロード
uploadBtn.addEventListener("click",async()=>{
  const user=auth.currentUser;
  if(!user||!user.emailVerified){status.textContent="ログインが必要です"; return;}
  const file=fileInput.files[0];
  if(!file){status.textContent="画像を選択してください"; return;}
  uploadBtn.disabled=true; status.textContent="アップロード中...";
  try{
    const ref=storage.ref(`test-images/${user.uid}`);
    await ref.put(file);
    const url=await ref.getDownloadURL();
    await db.collection("test-images").doc(user.uid).set({
      username:user.displayName||user.email,
      url,
      updatedAt:new Date()
    });
    status.textContent="アップロード完了！";
    fileInput.value="";
  }catch(e){ status.textContent="アップロード失敗"; }
  finally{ uploadBtn.disabled=false; }
});

// ギャラリー表示
db.collection("test-images").onSnapshot(snapshot=>{
  gallery.innerHTML="";
  snapshot.forEach(doc=>{
    const data=doc.data();
    const div=document.createElement("div"); div.className="card";
    const img=document.createElement("img"); img.src=data.url; div.appendChild(img);
    const meta=document.createElement("div"); meta.className="meta"; meta.textContent=`${data.username}\n${new Date(data.updatedAt.seconds*1000).toLocaleString()}`; div.appendChild(meta);
    img.onclick=()=>{overlayImg.src=data.url; overlay.style.display="flex";}
    gallery.appendChild(div);
  });
});
overlay.onclick=()=>{overlay.style.display="none"; overlayImg.src="";}
</script>
</body>
</html>

