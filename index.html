<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>クラス連絡＋画像共有アプリ</title>
<style>
body { box-sizing: border-box; font-family: system-ui,-apple-system,"メイリオ",sans-serif; margin:0; padding:20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#333; }
.container { max-width:900px; margin:0 auto; background:white; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.2); overflow:hidden; padding:20px; }
.header { background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%); color:white; padding:30px 20px; text-align:center; border-radius: 16px; margin-bottom: 20px; }
.header h1 { margin:0; font-size:24px; }
.bible-text { margin-top:8px; color:black; font-size:16px; line-height:1.5; }
.main-content { display:flex; flex-wrap:wrap; }
.date-buttons { padding:20px; display:grid; gap:12px; flex:1; border-right:2px solid #e1e8ff; min-width:260px; }
.date-row { display:flex; gap:8px; align-items:center; }
.date-row.horizontal { display:flex; flex-wrap: wrap; justify-content: space-between; margin-bottom:8px; }
.date-button, .omikuji-button { flex:1; margin:2px; }
.omikuji-button { background: linear-gradient(45deg,#ff9500 0%,#ff6a00 100%); color:white; border:none; padding:16px 20px; border-radius:12px; font-size:16px; font-weight:500; cursor:pointer; box-shadow:0 4px 15px rgba(255,149,0,0.3); text-align:center; }
.omikuji-button:hover { transform: translateY(-2px); box-shadow:0 6px 20px rgba(255,149,0,0.4); }
.omikuji-result { margin-top:8px; padding:10px; background:#fff7e6; border-radius:8px; border-left:4px solid #ff9500; font-size:14px; text-align:center; display:none; }
.schedule-display { flex:1; margin:20px; padding:20px; background:#f8f9ff; border-radius:12px; border-left:4px solid #4facfe; display:none; animation:fadeIn 0.3s ease; }
.schedule-display.show { display:block; }
@keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
.schedule-date { font-size:18px; font-weight:600; color:#4facfe; margin-bottom:15px; padding-bottom:8px; border-bottom:2px solid #e1e8ff; }
.schedule-content { font-size:15px; line-height:1.6; color:#555; }
.change-item { margin:8px 0; padding:8px 12px; background:white; border-radius:8px; border-left:3px solid #f5576c; }
.uploader { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:30px; }
#gallery { display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:12px; margin-top:20px; }
.card { border:1px solid #ddd; border-radius:8px; padding:8px; background:white; cursor:pointer; position:relative; transition:transform 0.2s; }
.card:hover { transform:scale(1.05); }
.card img { width:100%; height:140px; object-fit:cover; border-radius:6px; }
.meta { font-size:12px; color:#555; margin-top:6px; white-space:pre-line; }
.delete-btn { position:absolute; top:6px; right:6px; background:red; color:white; border:none; border-radius:4px; padding:2px 6px; font-size:12px; cursor:pointer; }
#modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:9999; }
#modal img { max-width:90%; max-height:90%; border-radius:10px; }
#status { font-size:13px; color:#333; margin-top:5px; }
button { cursor:pointer; padding:8px 12px; border-radius:6px; border:1px solid #bbb; background:#f7f7f7; }
</style>
</head>
<body>
<main class="container">
  <header class="header">
    <h1>11月14日（金）</h1>
    <div class="bible-text">Peace Truth LOVE</div>
  </header>

  <div class="main-content">
    <section class="date-buttons">
      <div class="date-row">
        <button class="omikuji-button" onclick="drawOmikuji()">おみくじ　1日2回</button>
      </div>
      <div id="omikujiResult" class="omikuji-result"></div>

      <div class="date-row horizontal">
        <button class="date-button" onclick="showSchedule('today')">本日</button>
        <button class="date-button" onclick="showSchedule('tomorrow')">明日</button>
        <button class="date-button" onclick="showSchedule('following')">明後日</button>
      </div>

      <div class="date-row"><button class="date-button" onclick="showSchedule('test1')">11月18日（火）</button></div>
      <div class="date-row"><button class="date-button" onclick="showSchedule('test2')">11月19日（水）</button></div>
      <div class="date-row"><button class="date-button" onclick="showSchedule('test3')">11月20日（木）</button></div>
      <div class="date-row"><button class="date-button" onclick="showSchedule('test4')">11月21日（金）</button></div>
    </section>

    <div id="scheduleDisplay" class="schedule-display">
      <div id="scheduleDate" class="schedule-date"></div>
      <div id="scheduleContent" class="schedule-content"></div>
    </div>
  </div>

  <section>
    <h2>画廊SHION</h2>
    <div id="gallery"></div>
  </section>
</main>

  <section class="uploader">
    <label>投稿者名（必須）<br><input id="username" type="text" placeholder=""></label>
    <label>画像を選択<br><input id="fileInput" type="file" accept="image/*"></label>
    <button id="uploadBtn">アップロード</button>
    <div id="status"></div>
  </section>

<div id="modal"><img id="modalImg" src=""></div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
// スケジュール・おみくじ
const scheduleData = {
  'today': { date: '本日', content:  '<div class="change-item">趣味は勉強、特技はテスト</div>' },
  'tomorrow': { date: '明日', content: '<div class="change-item">試験直前の土曜日を有効活用</div>' },
  'following': { date: '明後日', content: '<div class="change-item">試験直前の日曜日を有効活用</div>' },
  'test1': { date: '11月18日（火）', content:  '<div class="change-item">1限：論理国語</div><div class="change-item">2限：化学</div>' },
  'test2': { date: '11月19日（水）', content:  '<div class="change-item">1限：公共</div><div class="change-item">2限：論理・表現Ⅱ</div><div class="change-item">3限：地理探究</div>' },
  'test3': { date: '11月20日（木）', content:  '<div class="change-item">1限：古典探究</div><div class="change-item">2限：英語CⅡ</div>' },
  'test4': { date: '11月21日（金）', content:  '<div class="change-item">1限：物理/生物</div><div class="change-item">2限：数学ⅡB</div>' }
};

const omikujiResults = [
  {name:'凶',text:'隕石がぶつかる'},
  {name:'吉',text:'常北ファームで愛のささやき'},
  {name:'末吉',text:'脳筋大爆発！'},
  {name:'小吉',text:'脳みそ絶対零度'},
  {name:'中吉',text:'宇佐美を独り占め'},
  {name:'大吉',text:'萩谷と睨めっこ'}
];

function getTodayKey(){ const today=new Date(); return today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate(); }
function getDrawCount(){ const key=getTodayKey(); const data=JSON.parse(localStorage.getItem('omikujiCount'))||{}; return data[key]||0; }
function incrementDrawCount(){ const key=getTodayKey(); const data=JSON.parse(localStorage.getItem('omikujiCount'))||{}; data[key]=(data[key]||0)+1; localStorage.setItem('omikujiCount',JSON.stringify(data)); }
function getSecondResult(){ const key=getTodayKey()+'-secondResult'; return JSON.parse(localStorage.getItem(key)); }
function setSecondResult(result){ const key=getTodayKey()+'-secondResult'; localStorage.setItem(key,JSON.stringify(result)); }

function drawOmikuji(){
  const count = getDrawCount();
  const resultBox = document.getElementById('omikujiResult');
  resultBox.style.display='block';
  if(count===0){
    const r=Math.floor(Math.random()*omikujiResults.length);
    const result=omikujiResults[r];
    resultBox.innerHTML=`今日の運勢：<strong>${result.name}</strong><br>${result.text}`;
    incrementDrawCount();
  } else if(count===1){
    const r=Math.floor(Math.random()*omikujiResults.length);
    const result=omikujiResults[r];
    setSecondResult(result);
    resultBox.innerHTML=`今日の運勢：<strong>${result.name}</strong><br>${result.text}`;
    incrementDrawCount();
  } else {
    const saved=getSecondResult();
    if(saved){ resultBox.innerHTML=`今日の運勢：<strong>${saved.name}</strong><br>${saved.text}`; }
    else{ resultBox.innerHTML="（2回目の結果がありません）"; }
  }
}

function showSchedule(key){
  const d=document.getElementById('scheduleDisplay');
  const dd=document.getElementById('scheduleDate');
  const c=document.getElementById('scheduleContent');
  dd.textContent=scheduleData[key].date;
  c.innerHTML=scheduleData[key].content;
  d.classList.add('show');
}

// Firebase初期化
const firebaseConfig = {
  apiKey: "AIzaSyCzDqI2YaOLoU4muurvvxBs4fOOSkH8Yew",
  authDomain: "image-share-89916.firebaseapp.com",
  projectId: "image-share-89916",
  storageBucket: "image-share-89916.firebasestorage.app",
  messagingSenderId: "859639070035",
  appId: "1:859639070035:web:aab7543659c3d1a877f5a6"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const storage=firebase.storage();

const usernameInput = document.getElementById("username");
const fileInput = document.getElementById("fileInput");
const uploadBtn = document.getElementById("uploadBtn");
const status = document.getElementById("status");
const gallery = document.getElementById("gallery");
const modal = document.getElementById("modal");
const modalImg = document.getElementById("modalImg");

// アップロード
uploadBtn.addEventListener("click", async ()=>{
  const name=usernameInput.value.trim();
  const file=fileInput.files[0];
  if(!name){ status.textContent="投稿者名を入力してください。"; return; }
  if(!file){ status.textContent="画像を選択してください。"; return; }
  uploadBtn.disabled=true; status.textContent="アップロード中...";
  try{
    const ref=storage.ref("test-images/"+name+".jpg");
    await ref.put(file);
    const url=await ref.getDownloadURL();
    await db.collection("test-images").doc(name).set({username:name,url:url,updatedAt:new Date()});
    status.textContent="アップロード完了！";
    fileInput.value="";
  }catch(e){ console.error(e); status.textContent="アップロード失敗。"; }
  finally{ uploadBtn.disabled=false; }
});

// ギャラリー更新（削除ボタン付き）
db.collection("test-images").onSnapshot(snapshot=>{
  gallery.innerHTML="";
  snapshot.forEach(doc=>{
    const data=doc.data();
    const div=document.createElement("div");
    div.className="card";
    const docId = doc.id;

    const imgEl = document.createElement("img");
    imgEl.src = data.url;
    div.appendChild(imgEl);

    const metaDiv = document.createElement("div");
    metaDiv.className="meta";
    metaDiv.textContent = `${data.username}\n${new Date(data.updatedAt.seconds*1000).toLocaleString()}`;
    div.appendChild(metaDiv);

    // Fire Storageに存在するかチェック
    storage.ref("test-images/"+data.username+".jpg").getMetadata()
      .then(()=>{/* 画像存在 → 削除ボタンなし */})
      .catch(()=>{
        // Storageにない場合のみ削除ボタン追加
        const delBtn = document.createElement("button");
        delBtn.className="delete-btn";
        delBtn.textContent="削除";
        delBtn.addEventListener("click", async e=>{
          e.stopPropagation();
          if(!confirm("Fire Storage上の画像は削除済みです。Firestoreからも削除しますか？")) return;
          try{
            await db.collection("test-images").doc(docId).delete();
            status.textContent="Firestore上のデータを削除しました";
          }catch(err){
            console.error(err);
            status.textContent="削除失敗";
          }
        });
        div.appendChild(delBtn);
      });

    imgEl.addEventListener("click", ()=>{ modalImg.src=data.url; modal.style.display="flex"; });

    gallery.appendChild(div);
  });
});

modal.addEventListener("click", ()=>{ modal.style.display="none"; modalImg.src=""; });
</script>
</body>
</html>

